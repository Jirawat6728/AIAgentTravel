<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="AI Travel Agent - Admin Dashboard">
    <title>Admin Dashboard - AI Travel Agent</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue.js 2 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    
    <style>
        /* Custom Scrollbars */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Fade animations */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s;
        }
        .fade-enter, .fade-leave-to {
            opacity: 0;
        }
        
        /* Status badges */
        .status-ok { @apply bg-green-100 text-green-800 border-green-300; }
        .status-error { @apply bg-red-100 text-red-800 border-red-300; }
        .status-warning { @apply bg-yellow-100 text-yellow-800 border-yellow-300; }
        
        /* Modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div id="app">
        <!-- Loading Overlay -->
        <div v-if="initialLoading" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
            <div class="text-center">
                <div class="spinner mx-auto mb-4"></div>
                <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            </div>
        </div>

        <!-- Error Banner -->
        <div v-if="globalError" class="bg-red-600 text-white px-4 py-3 flex justify-between items-center">
            <span>{{ globalError }}</span>
            <button @click="globalError = null" class="text-white hover:text-gray-200">‚úï</button>
                    </div>
        
        <!-- Main Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Admin Dashboard</h1>
                        <p class="text-sm text-gray-500 mt-1">AI Travel Agent - System Monitoring</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-sm text-gray-600" v-if="lastUpdate">{{ formatTime(lastUpdate) }}</p>
                            <p class="text-xs text-gray-400">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
                    </div>
                        <button @click="refreshAll" :disabled="isLoading" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span v-if="!isLoading">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</span>
                            <span v-else>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä...</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            
            <!-- Dashboard Overview (Services, System, Config) -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                
                <!-- 1. Services Status (Compact) -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <span class="mr-2">üîå</span> Services Status
                </h2>
                    <div class="space-y-1">
                        <div v-for="(service, name) in statusData.services" :key="name" class="flex justify-between items-center py-3 border-b border-gray-100 last:border-0">
                            <div class="flex flex-col">
                                <span class="font-semibold text-gray-700 capitalize">{{ name.replace('_', ' ') }}</span>
                                <span class="text-xs text-gray-500 truncate max-w-[180px]" :title="service.message">{{ service.message }}</span>
                            </div>
                            <span class="px-2.5 py-0.5 text-xs font-bold rounded-full border"
                                  :class="{'status-ok': service.status === 'ok', 'status-error': service.status === 'error'}">
                                {{ service.status === 'ok' ? 'ONLINE' : 'OFFLINE' }}
                            </span>
                    </div>
                    </div>
                </div>

                <!-- 2. System Resources -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <span class="mr-2">üíª</span> System Resources
                    </h2>
                    <div class="space-y-5" v-if="statusData.system">
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-gray-700">CPU Usage</span>
                                <span class="text-sm text-gray-600 font-mono">{{ statusData.system.cpu_usage_percent?.toFixed(1) || 0 }}%</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden">
                                <div class="bg-blue-500 h-2.5 rounded-full transition-all duration-500" 
                                     :style="{width: (statusData.system.cpu_usage_percent || 0) + '%'}"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-gray-700">Memory Usage</span>
                                <span class="text-sm text-gray-600 font-mono">{{ statusData.system.memory_usage_mb || 0 }} MB</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden">
                                <div class="bg-purple-500 h-2.5 rounded-full transition-all duration-500" 
                                     :style="{width: Math.min((statusData.system.memory_usage_mb / 2048) * 100, 100) + '%'}"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 pt-2 border-t border-gray-100 mt-2">
                            <div class="text-center">
                                <p class="text-xs text-gray-500 uppercase tracking-wider">Uptime</p>
                                <p class="text-sm font-bold text-gray-800 font-mono">{{ formatUptime(statusData.system.uptime_seconds) }}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-gray-500 uppercase tracking-wider">Threads</p>
                                <p class="text-sm font-bold text-gray-800 font-mono">{{ statusData.system.active_threads || 0 }}</p>
                    </div>
                    </div>
                </div>
            </div>

                <!-- 3. Configuration -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <span class="mr-2">‚öôÔ∏è</span> Configuration
                </h2>
                    <div class="space-y-0 text-sm" v-if="statusData.config">
                        <div class="flex justify-between py-3 border-b border-gray-100">
                            <span class="text-gray-600">Gemini Model</span>
                            <span class="font-medium text-gray-900">{{ statusData.config.gemini_model || 'N/A' }}</span>
                        </div>
                        <div class="flex justify-between py-3 border-b border-gray-100">
                            <span class="text-gray-600">Safety Guard</span>
                            <span class="font-bold px-2 py-0.5 rounded text-xs" 
                                  :class="statusData.config.amadeus_safety_guard ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                {{ statusData.config.amadeus_safety_guard ? 'ENABLED' : 'DISABLED' }}
                        </span>
                    </div>
                        <div class="flex justify-between py-3 border-b border-gray-100">
                            <span class="text-gray-600">Amadeus Env</span>
                            <span class="font-medium text-gray-900">{{ statusData.config.amadeus_env || 'N/A' }}</span>
                    </div>
                        <div class="flex justify-between py-3 border-b border-gray-100">
                        <span class="text-gray-600">Amadeus Search</span>
                            <span class="font-medium text-gray-900">{{ statusData.config.amadeus_search_env || 'N/A' }}</span>
                    </div>
                        <div class="flex justify-between py-3 border-b-0">
                        <span class="text-gray-600">Amadeus Booking</span>
                            <span class="font-medium text-gray-900">{{ statusData.config.amadeus_booking_env || 'N/A' }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Trips & Chats -->
            <div class="bg-white rounded-lg shadow mb-6">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-900">Recent Trips & Chats</h2>
                    <button @click="loadSessions" :disabled="isLoading" 
                            class="text-sm text-blue-600 hover:text-blue-800 disabled:opacity-50">
                        {{ isLoading ? 'Loading...' : 'Refresh' }}
                    </button>
        </div>
                <div class="overflow-x-auto custom-scrollbar">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10"></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trip / Chat Info</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Updated</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template v-if="groupedSessions.length === 0 && !isLoading">
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">No sessions found</td>
                                </tr>
                            </template>
                            
                            <template v-for="group in groupedSessions">
                                <!-- Trip Header Row -->
                                <tr :key="group.key" class="hover:bg-gray-50 cursor-pointer" @click="toggleTrip(group.key)">
                                    <td class="px-6 py-4 whitespace-nowrap text-gray-500">
                                        <span v-if="group.chats.length > 0">
                                            <svg v-if="expandedTrips.includes(group.key)" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                            </svg>
                                            <svg v-else xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                            </svg>
                                </span>
                            </td>
                                    <td class="px-6 py-4">
                                        <div class="flex items-center">
                                            <span class="font-medium text-gray-900">{{ group.title }}</span>
                                            <span v-if="group.trip_id" class="ml-2 px-2 py-0.5 text-xs bg-blue-100 text-blue-800 rounded-full">Trip</span>
                                            <span v-else class="ml-2 px-2 py-0.5 text-xs bg-gray-100 text-gray-800 rounded-full">Single Chat</span>
                                            <span class="ml-2 px-2 py-0.5 text-xs bg-gray-200 text-gray-600 rounded-full">{{ group.chats.length }} chats</span>
                                        </div>
                                        <div class="flex items-center mt-1">
                                            <span class="text-xs text-gray-500 mr-1">Trip ID:</span>
                                            <code class="text-xs bg-gray-100 px-1.5 py-0.5 rounded text-blue-600 font-bold">{{ group.trip_id || group.key }}</code>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                        {{ group.user_id }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {{ formatTime(group.last_updated) }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <!-- Actions for Trip (if needed) -->
                                    </td>
                        </tr>
                                
                                <!-- Chat Sub-rows -->
                                <template v-if="expandedTrips.includes(group.key)">
                                    <tr v-for="chat in group.chats" :key="chat._id || chat.session_id" class="bg-gray-50">
                                        <td></td>
                                        <td class="px-6 py-3 pl-12 border-l-4 border-blue-200">
                                            <div class="flex items-center">
                                                <span class="text-sm font-medium text-gray-700">Chat</span>
                                                <code class="ml-2 text-xs bg-gray-100 px-1.5 py-0.5 rounded text-gray-600 font-mono">{{ chat.chat_id || chat.session_id }}</code>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-1" v-if="chat.title && chat.title !== group.title">
                                                Topic: {{ chat.title }}
                                            </div>
                                        </td>
                                        <td class="px-6 py-3 text-sm text-gray-500">
                                            <!-- Same User ID -->
                                        </td>
                                        <td class="px-6 py-3 text-sm text-gray-500">
                                            {{ formatTime(chat.last_updated) }}
                                        </td>
                                        <td class="px-6 py-3 text-sm">
                                            <button @click.stop="viewSessionDetails(chat)" 
                                                    class="text-blue-600 hover:text-blue-800 text-xs font-medium bg-white px-3 py-1 rounded border border-blue-200 hover:bg-blue-50">
                                                Debug Chat
                                            </button>
                                        </td>
                        </tr>
                                </template>
                            </template>
                    </tbody>
                </table>
            </div>
        </div>

            <!-- Agent Activity Feed -->
            <div class="bg-white rounded-lg shadow mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-900">Agent Activity Feed</h2>
                </div>
                <div class="p-6 max-h-96 overflow-y-auto custom-scrollbar">
                    <div v-if="agentActivities.length === 0" class="text-center text-gray-500 py-8">
                        No activities yet
                    </div>
                    <div v-for="(activity, index) in agentActivities" :key="index" 
                         class="border-l-4 pl-4 mb-4"
                         :class="{
                             'border-blue-500': activity.type === 'thought',
                             'border-green-500': activity.type === 'action',
                             'border-purple-500': activity.type === 'response',
                             'border-red-500': activity.type === 'error'
                         }">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-900">{{ activity.message }}</p>
                                <p class="text-xs text-gray-500 mt-1">
                                    Session: {{ activity.session_id }} | User: {{ activity.user_id }}
                                </p>
                            </div>
                            <span class="text-xs text-gray-400 ml-4">{{ formatTime(activity.timestamp) }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- System Logs -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-900">System Logs</h2>
                    <div class="flex items-center space-x-4">
                        <input v-model.number="logLines" type="number" min="50" max="1000" step="50"
                               class="border border-gray-300 rounded px-3 py-1 text-sm w-24">
                        <button @click="loadLogs" :disabled="isLoading"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                            Load Logs
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div v-if="logsError" class="text-red-600 mb-4">{{ logsError }}</div>
                    <div v-else-if="logContent" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-xs overflow-auto max-h-96 custom-scrollbar">
                        <div v-for="(line, index) in logContent" :key="index" class="whitespace-pre-wrap">{{ line }}</div>
                    </div>
                    <div v-else class="text-gray-500 text-center py-8">Click "Load Logs" to view system logs</div>
                </div>
            </div>
        </main>
        
        <!-- Session Details Modal -->
        <div v-if="selectedSession" class="fixed inset-0 z-50 overflow-y-auto modal-backdrop" @click.self="selectedSession = null">
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
                <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-7xl sm:w-full">
                    <div class="bg-white px-6 py-4 border-b border-gray-200 flex justify-between items-center sticky top-0 z-10">
                        <h3 class="text-lg font-bold text-gray-900">Session Details</h3>
                        <button @click="selectedSession = null" type="button" class="bg-gray-100 rounded-full p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-200 transition-colors focus:outline-none">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="bg-white px-6 py-4 max-h-[80vh] overflow-y-auto custom-scrollbar">
                        <div v-if="selectedSession.trip_plan" class="space-y-6">
                            
                            <!-- ‚úàÔ∏è Flights Section -->
                            <div v-if="selectedSession.trip_plan.travel?.flights" class="border rounded-lg p-4 bg-blue-50 border-blue-100">
                                <h4 class="font-bold text-blue-800 mb-3 flex items-center">
                                    ‚úàÔ∏è Flights Data
                                </h4>
                                
                                <!-- Outbound -->
                                <div v-if="selectedSession.trip_plan.travel.flights.outbound?.length > 0">
                                    <p class="text-sm font-semibold text-blue-700 mb-2">Outbound Segments:</p>
                                    <div v-for="(seg, idx) in selectedSession.trip_plan.travel.flights.outbound" :key="'out-'+idx" class="ml-2 mb-4 p-3 bg-white rounded shadow-sm">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-xs font-mono bg-blue-100 text-blue-800 px-2 py-1 rounded">Segment {{ idx + 1 }}</span>
                                            <span class="text-xs text-gray-500">Status: {{ seg.status }}</span>
                                        </div>
                                        
                                        <!-- Selected Option -->
                                        <div v-if="seg.selected_option" class="mb-2 text-xs">
                                            <span class="font-semibold text-green-600">Selected:</span>
                                            <span class="font-bold text-blue-600 mr-1">{{ getOptionLabel(seg.options_pool, seg.selected_option) }}</span>
                                            {{ getFlightInfo(seg.selected_option) }}
                                        </div>

                                        <!-- Raw Options Pool (Interactive) -->
                                        <div class="mt-3 bg-gray-50 rounded border border-gray-200 p-3" v-if="seg.options_pool?.length > 0">
                                            <div class="flex justify-between items-center mb-2">
                                                <span class="text-xs font-bold text-gray-700">Options Pool ({{ seg.options_pool.length }} items)</span>
                                                <button @click="toggleFullRaw(getKey('flight-out', idx))" class="text-[10px] text-blue-600 hover:underline">
                                                    {{ showFullRaw[getKey('flight-out', idx)] ? 'Hide' : 'Show' }} All Raw Data
                                                </button>
                                            </div>

                                            <!-- Full Raw Data View -->
                                            <div v-if="showFullRaw[getKey('flight-out', idx)]" class="mb-3">
                                                <div class="w-full bg-white border border-gray-200 rounded p-2 overflow-auto max-h-96 custom-scrollbar">
                                                    <json-tree :data="seg.options_pool"></json-tree>
                                                </div>
                                            </div>

                                            <!-- Option Selector -->
                                            <div class="flex flex-wrap gap-1 mb-3">
                                                <button v-for="(opt, optIdx) in seg.options_pool" :key="optIdx"
                                                        @click="selectOption(getKey('flight-out', idx), optIdx)"
                                                        class="px-2 py-1 text-xs border rounded transition-colors"
                                                        :class="getSelectedOption(getKey('flight-out', idx)) === optIdx ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-100'">
                                                    {{ optIdx + 1 }}
                                                </button>
                                            </div>

                                            <!-- Selected Option Detail -->
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3" v-if="seg.options_pool[getSelectedOption(getKey('flight-out', idx))]">
                                                <!-- Info Column -->
                                                <div class="bg-white p-3 rounded border border-gray-200">
                                                    <p class="text-xs font-bold text-gray-800 mb-1">Info:</p>
                                                    <p class="text-xs text-gray-600">{{ getFlightInfo(seg.options_pool[getSelectedOption(getKey('flight-out', idx))]) }}</p>
                                                    <p class="text-xs font-semibold text-green-600 mt-1" v-if="seg.options_pool[getSelectedOption(getKey('flight-out', idx))].price_amount">
                                                        {{ seg.options_pool[getSelectedOption(getKey('flight-out', idx))].price_amount }} 
                                                        {{ seg.options_pool[getSelectedOption(getKey('flight-out', idx))].currency }}
                                                    </p>
                                                </div>
                                                <!-- Raw JSON Column -->
                                                <div class="bg-white rounded border border-gray-200 overflow-hidden">
                                                    <div class="bg-gray-50 px-2 py-1 text-[10px] font-bold text-gray-700 border-b border-gray-200">Raw JSON</div>
                                                    <div class="p-2 overflow-auto max-h-96 custom-scrollbar">
                                                        <json-tree :data="seg.options_pool[getSelectedOption(getKey('flight-out', idx))]"></json-tree>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Inbound -->
                                <div v-if="selectedSession.trip_plan.travel.flights.inbound?.length > 0" class="mt-4">
                                    <p class="text-sm font-semibold text-blue-700 mb-2">Inbound Segments:</p>
                                    <div v-for="(seg, idx) in selectedSession.trip_plan.travel.flights.inbound" :key="'in-'+idx" class="ml-2 mb-4 p-3 bg-white rounded shadow-sm">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-xs font-mono bg-blue-100 text-blue-800 px-2 py-1 rounded">Segment {{ idx + 1 }}</span>
                                            <span class="text-xs text-gray-500">Status: {{ seg.status }}</span>
                                        </div>
                                        
                                        <div v-if="seg.selected_option" class="mb-2 text-xs">
                                            <span class="font-semibold text-green-600">Selected:</span>
                                            <span class="font-bold text-blue-600 mr-1">{{ getOptionLabel(seg.options_pool, seg.selected_option) }}</span>
                                            {{ getFlightInfo(seg.selected_option) }}
                                        </div>

                                        <!-- Raw Options Pool (Interactive) -->
                                        <div class="mt-3 bg-gray-50 rounded border border-gray-200 p-3" v-if="seg.options_pool?.length > 0">
                                            <div class="flex justify-between items-center mb-2">
                                                <span class="text-xs font-bold text-gray-700">Options Pool ({{ seg.options_pool.length }} items)</span>
                                                <button @click="toggleFullRaw(getKey('flight-in', idx))" class="text-[10px] text-blue-600 hover:underline">
                                                    {{ showFullRaw[getKey('flight-in', idx)] ? 'Hide' : 'Show' }} All Raw Data
                                                </button>
                                            </div>

                                            <div v-if="showFullRaw[getKey('flight-in', idx)]" class="mb-3">
                                                <div class="w-full bg-white border border-gray-200 rounded p-2 overflow-auto max-h-96 custom-scrollbar">
                                                    <json-tree :data="seg.options_pool"></json-tree>
                                                </div>
                                            </div>

                                            <div class="flex flex-wrap gap-1 mb-3">
                                                <button v-for="(opt, optIdx) in seg.options_pool" :key="optIdx"
                                                        @click="selectOption(getKey('flight-in', idx), optIdx)"
                                                        class="px-2 py-1 text-xs border rounded transition-colors"
                                                        :class="getSelectedOption(getKey('flight-in', idx)) === optIdx ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-100'">
                                                    {{ optIdx + 1 }}
                                                </button>
                                            </div>

                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3" v-if="seg.options_pool[getSelectedOption(getKey('flight-in', idx))]">
                                                <div class="bg-white p-3 rounded border border-gray-200">
                                                    <p class="text-xs font-bold text-gray-800 mb-1">Info:</p>
                                                    <p class="text-xs text-gray-600">{{ getFlightInfo(seg.options_pool[getSelectedOption(getKey('flight-in', idx))]) }}</p>
                                                </div>
                                                <div class="bg-white rounded border border-gray-200 overflow-hidden">
                                                    <div class="bg-gray-50 px-2 py-1 text-[10px] font-bold text-gray-700 border-b border-gray-200">Raw JSON</div>
                                                    <div class="p-2 overflow-auto max-h-96 custom-scrollbar">
                                                        <json-tree :data="seg.options_pool[getSelectedOption(getKey('flight-in', idx))]"></json-tree>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- üè® Accommodation Section -->
                            <div v-if="selectedSession.trip_plan.accommodation?.segments?.length > 0" class="border rounded-lg p-4 bg-purple-50 border-purple-100">
                                <h4 class="font-bold text-purple-800 mb-3 flex items-center">
                                    üè® Accommodation Data
                                </h4>
                                <div v-for="(seg, idx) in selectedSession.trip_plan.accommodation.segments" :key="'hotel-'+idx" class="mb-4 p-3 bg-white rounded shadow-sm">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-xs font-mono bg-purple-100 text-purple-800 px-2 py-1 rounded">Stay {{ idx + 1 }}</span>
                                        <span class="text-xs text-gray-500">Status: {{ seg.status }}</span>
                                    </div>
                                    
                                    <div v-if="seg.selected_option" class="mb-2 text-xs">
                                        <span class="font-semibold text-green-600">Selected:</span>
                                        <span class="font-bold text-blue-600 mr-1">{{ getOptionLabel(seg.options_pool, seg.selected_option) }}</span>
                                        {{ getAccommodationInfo(seg.selected_option) }}
                                    </div>

                                    <!-- Raw Options Pool (Interactive) -->
                                    <div class="mt-3 bg-gray-50 rounded border border-gray-200 p-3" v-if="seg.options_pool?.length > 0">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-xs font-bold text-gray-700">Options Pool ({{ seg.options_pool.length }} items)</span>
                                            <button @click="toggleFullRaw(getKey('hotel', idx))" class="text-[10px] text-purple-600 hover:underline">
                                                {{ showFullRaw[getKey('hotel', idx)] ? 'Hide' : 'Show' }} All Raw Data
                                            </button>
                                        </div>

                                        <div v-if="showFullRaw[getKey('hotel', idx)]" class="mb-3">
                                            <div class="w-full bg-white border border-gray-200 rounded p-2 overflow-auto max-h-96 custom-scrollbar">
                                                <json-tree :data="seg.options_pool"></json-tree>
                                            </div>
                                        </div>

                                        <div class="flex flex-wrap gap-1 mb-3">
                                            <button v-for="(opt, optIdx) in seg.options_pool" :key="optIdx"
                                                    @click="selectOption(getKey('hotel', idx), optIdx)"
                                                    class="px-2 py-1 text-xs border rounded transition-colors"
                                                    :class="getSelectedOption(getKey('hotel', idx)) === optIdx ? 'bg-purple-600 text-white border-purple-600' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-100'">
                                                {{ optIdx + 1 }}
                                            </button>
                                        </div>

                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3" v-if="seg.options_pool[getSelectedOption(getKey('hotel', idx))]">
                                            <div class="bg-white p-3 rounded border border-gray-200">
                                                <p class="text-xs font-bold text-gray-800 mb-1">Info:</p>
                                                <p class="text-xs text-gray-600">{{ getAccommodationInfo(seg.options_pool[getSelectedOption(getKey('hotel', idx))]) }}</p>
                                            </div>
                                            <div class="bg-white rounded border border-gray-200 overflow-hidden">
                                                <div class="bg-gray-50 px-2 py-1 text-[10px] font-bold text-gray-700 border-b border-gray-200">Raw JSON</div>
                                                <div class="p-2 overflow-auto max-h-96 custom-scrollbar">
                                                    <json-tree :data="seg.options_pool[getSelectedOption(getKey('hotel', idx))]"></json-tree>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- üöó Transport Section -->
                            <div v-if="selectedSession.trip_plan.travel?.ground_transport?.length > 0" class="border rounded-lg p-4 bg-yellow-50 border-yellow-100">
                                <h4 class="font-bold text-yellow-800 mb-3 flex items-center">
                                    üöó Transport Data
                                </h4>
                                <div v-for="(seg, idx) in selectedSession.trip_plan.travel.ground_transport" :key="'car-'+idx" class="mb-4 p-3 bg-white rounded shadow-sm">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-xs font-mono bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Ride {{ idx + 1 }}</span>
                                        <span class="text-xs text-gray-500">Status: {{ seg.status }}</span>
        </div>

                                    <div v-if="seg.selected_option" class="mb-2 text-xs">
                                        <span class="font-semibold text-green-600">Selected:</span>
                                        <span class="font-bold text-blue-600 mr-1">{{ getOptionLabel(seg.options_pool, seg.selected_option) }}</span>
                                        {{ seg.selected_option.vehicle_name || 'N/A' }}
                                    </div>

                                    <!-- Raw Options Pool (Interactive) -->
                                    <div class="mt-3 bg-gray-50 rounded border border-gray-200 p-3" v-if="seg.options_pool?.length > 0">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-xs font-bold text-gray-700">Options Pool ({{ seg.options_pool.length }} items)</span>
                                            <button @click="toggleFullRaw(getKey('car', idx))" class="text-[10px] text-yellow-600 hover:underline">
                                                {{ showFullRaw[getKey('car', idx)] ? 'Hide' : 'Show' }} All Raw Data
                                            </button>
                                        </div>

                                        <div v-if="showFullRaw[getKey('car', idx)]" class="mb-3">
                                            <div class="w-full bg-white border border-gray-200 rounded p-2 overflow-auto max-h-96 custom-scrollbar">
                                                <json-tree :data="seg.options_pool"></json-tree>
                                            </div>
                                        </div>

                                        <div class="flex flex-wrap gap-1 mb-3">
                                            <button v-for="(opt, optIdx) in seg.options_pool" :key="optIdx"
                                                    @click="selectOption(getKey('car', idx), optIdx)"
                                                    class="px-2 py-1 text-xs border rounded transition-colors"
                                                    :class="getSelectedOption(getKey('car', idx)) === optIdx ? 'bg-yellow-600 text-white border-yellow-600' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-100'">
                                                {{ optIdx + 1 }}
                                            </button>
                                        </div>

                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3" v-if="seg.options_pool[getSelectedOption(getKey('car', idx))]">
                                            <div class="bg-white p-3 rounded border border-gray-200">
                                                <p class="text-xs font-bold text-gray-800 mb-1">Info:</p>
                                                <p class="text-xs text-gray-600">{{ opt.vehicle_name || 'Unknown Car' }}</p>
                                            </div>
                                            <div class="bg-white rounded border border-gray-200 overflow-hidden">
                                                <div class="bg-gray-50 px-2 py-1 text-[10px] font-bold text-gray-700 border-b border-gray-200">Raw JSON</div>
                                                <div class="p-2 overflow-auto max-h-96 custom-scrollbar">
                                                    <json-tree :data="seg.options_pool[getSelectedOption(getKey('car', idx))]"></json-tree>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                </div>
            </div>
                            
                            <!-- Full Session Raw JSON -->
                            <details class="mt-6 pt-4 border-t border-gray-200">
                                <summary class="cursor-pointer text-sm font-bold text-gray-900 hover:text-blue-600">
                                    üìÑ Full Session JSON (Debug)
                                </summary>
                                <div class="mt-3 bg-white border border-gray-200 rounded p-4 overflow-auto max-h-96 custom-scrollbar">
                                    <json-tree :data="selectedSession"></json-tree>
                                </div>
                            </details>
                        </div>
                        <div v-else class="text-gray-500 text-center py-10">No trip plan data available</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        // Recursive JSON Tree Component
        Vue.component('json-tree', {
            props: {
                data: [Object, Array, String, Number, Boolean, null],
                level: { type: Number, default: 0 },
                mKey: { type: String, default: '' }
            },
            data() {
                return {
                    expanded: this.level < 1 // Expand only top level by default
                }
            },
            template: `
            <div :class="['font-mono text-xs', level > 0 ? 'ml-4' : '']">
                <!-- Primitive / Null -->
                <div v-if="!isObject && !isArray" class="hover:bg-gray-50 flex py-0.5">
                    <span v-if="mKey" class="text-purple-700 mr-1 select-none">{{ mKey }}:</span>
                    <span :class="valueClass" class="break-all">{{ formatValue(data) }}</span>
                    <span class="text-gray-400 select-none">,</span>
                </div>

                <!-- Object / Array -->
                <div v-else class="py-0.5">
                    <div @click="toggle" class="cursor-pointer hover:bg-gray-100 flex items-center select-none group">
                        <span class="text-gray-400 mr-1 text-[10px] transform transition-transform" :class="{'rotate-90': expanded}">‚ñ∂</span>
                        <span v-if="mKey" class="text-purple-700 mr-1">{{ mKey }}:</span>
                        <span class="text-gray-600 font-bold">{{ isArray ? '[' : '{' }}</span>
                        <span v-if="!expanded" class="text-gray-400 text-[10px] ml-1 bg-gray-50 px-1 rounded border border-gray-100 group-hover:bg-white">
                            {{ isArray ? data.length + ' items' : Object.keys(data).length + ' keys' }}
                        </span>
                        <span v-if="!expanded" class="text-gray-600 font-bold ml-1">{{ isArray ? ']' : '}' }}</span>
                        <span v-if="!expanded" class="text-gray-400 ml-0.5">,</span>
                    </div>
                    
                    <div v-show="expanded" class="border-l border-gray-200 pl-1 my-0.5">
                        <json-tree v-for="(val, key) in data" 
                                   :key="key" 
                                   :data="val" 
                                   :m-key="isArray ? '' : key"
                                   :level="level + 1">
                        </json-tree>
                        <div class="text-gray-600 font-bold select-none">{{ isArray ? ']' : '}' }},</div>
                    </div>
                </div>
            </div>
            `,
            computed: {
                isObject() { return this.data !== null && typeof this.data === 'object' && !Array.isArray(this.data) },
                isArray() { return Array.isArray(this.data) },
                valueClass() {
                    if (this.data === null) return 'text-gray-400 italic';
                    if (typeof this.data === 'string') return 'text-green-600';
                    if (typeof this.data === 'number') return 'text-blue-600';
                    if (typeof this.data === 'boolean') return 'text-red-600 font-bold';
                    return 'text-gray-500';
                }
            },
            methods: {
                toggle() { this.expanded = !this.expanded },
                formatValue(val) {
                    if (val === null) return 'null';
                    if (typeof val === 'string') return '"' + val + '"';
                    return val + '';
                }
            }
        });
        
        new Vue({
            el: '#app',
            data: {
                initialLoading: true,
                isLoading: false,
                globalError: null,
                statusData: {
                    services: {},
                    system: {},
                    config: {}
                },
                sessions: [],
                expandedTrips: [], // Track expanded trip keys
                agentActivities: [],
                logContent: null,
                logsError: null,
                logLines: 100,
                selectedSession: null,
                lastUpdate: null,
                eventSource: null,
                selectedOptions: {}, // Store selected option index for each segment
                showFullRaw: {} // Store visibility of full raw data
            },
            mounted() {
                this.initializeDashboard();
            },
            beforeDestroy() {
                if (this.eventSource) {
                    this.eventSource.close();
                }
            },
            computed: {
                groupedSessions() {
                    const groups = {};
                    this.sessions.forEach(sess => {
                        // Use trip_id if available, otherwise fallback to session_id
                        // If both missing, use 'unknown'
                        const key = sess.trip_id || sess.session_id || 'unknown';
                        
                        if (!groups[key]) {
                            groups[key] = {
                                key: key,
                                trip_id: sess.trip_id,
                                title: sess.title || (sess.trip_id ? 'Untitled Trip' : 'Untitled Chat'),
                                user_id: sess.user_id,
                                last_updated: sess.last_updated,
                                chats: []
                            };
                        }
                        
                        // Update trip info if we find a more recent session or better title
                        if (new Date(sess.last_updated) > new Date(groups[key].last_updated)) {
                            groups[key].last_updated = sess.last_updated;
                            if (sess.title && !groups[key].title.includes('Untitled')) {
                                groups[key].title = sess.title;
                            }
                        }
                        
                        groups[key].chats.push(sess);
                    });
                    
                    // Sort trips by last_updated desc
                    return Object.values(groups).sort((a, b) => 
                        new Date(b.last_updated) - new Date(a.last_updated)
                    );
                }
            },
            methods: {
                toggleTrip(key) {
                    const index = this.expandedTrips.indexOf(key);
                    if (index === -1) {
                        this.expandedTrips.push(key);
                    } else {
                        this.expandedTrips.splice(index, 1);
                    }
                },
                
                async initializeDashboard() {
                    try {
                        await Promise.all([
                            this.loadStatus(),
                            this.loadSessions(),
                            this.loadLogs()
                        ]);
                        this.startSSE();
                        this.initialLoading = false;
                    } catch (error) {
                        console.error('Failed to initialize dashboard:', error);
                        this.globalError = 'Failed to load dashboard. Please refresh the page.';
                        this.initialLoading = false;
                    }
                },
                
                async loadStatus() {
                    try {
                        const response = await fetch(API_BASE + '/api/admin/status', {
                            credentials: 'include'
                        });
                        if (!response.ok) {
                            if (response.status === 401) {
                                this.globalError = 'Authentication required. Please set ADMIN_PASSWORD in .env';
                            return;
                            }
                            throw new Error(`HTTP ${response.status}`);
                        }
                        const data = await response.json();
                        this.statusData = data;
                        this.lastUpdate = new Date();
                    } catch (error) {
                        console.error('Failed to load status:', error);
                        this.globalError = 'Failed to load system status: ' + error.message;
                    }
                },
                
                async loadSessions() {
                    this.isLoading = true;
                    try {
                        // Increase limit to get more sessions for grouping
                        const response = await fetch(API_BASE + '/api/admin/sessions?limit=50', {
                            credentials: 'include'
                        });
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        const data = await response.json();
                        this.sessions = Array.isArray(data) ? data : [];
                    } catch (error) {
                        console.error('Failed to load sessions:', error);
                        this.globalError = 'Failed to load sessions: ' + error.message;
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                async loadLogs() {
                    this.isLoading = true;
                    this.logsError = null;
                    try {
                        const response = await fetch(API_BASE + '/api/admin/logs?lines=' + this.logLines, {
                            credentials: 'include'
                        });
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        const data = await response.json();
                        if (data.content) {
                            this.logContent = Array.isArray(data.content) ? data.content : [data.content];
                        } else {
                            this.logsError = data.message || 'No logs available';
                        }
                    } catch (error) {
                        console.error('Failed to load logs:', error);
                        this.logsError = 'Failed to load logs: ' + error.message;
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                startSSE() {
                    try {
                        this.eventSource = new EventSource(API_BASE + '/api/admin/stream');
                        this.eventSource.onmessage = (event) => {
                            try {
                                const data = JSON.parse(event.data);
                                this.statusData = {
                                    ...this.statusData,
                                    ...data
                                };
                                if (data.agent_activities) {
                                    this.agentActivities = data.agent_activities;
                                }
                                this.lastUpdate = new Date();
                            } catch (error) {
                                console.error('Failed to parse SSE data:', error);
                            }
                        };
                        this.eventSource.onerror = (error) => {
                            console.error('SSE error:', error);
                            if (this.eventSource.readyState === EventSource.CLOSED) {
                                setTimeout(() => this.startSSE(), 5000);
                            }
                        };
                    } catch (error) {
                        console.error('Failed to start SSE:', error);
                    }
                },
                
                async refreshAll() {
                    this.isLoading = true;
                    try {
                        await Promise.all([
                            this.loadStatus(),
                            this.loadSessions()
                        ]);
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                viewSessionDetails(session) {
                    this.selectedSession = session;
                    this.selectedOptions = {}; // Reset selections
                    this.showFullRaw = {};
                },
                
                getKey(type, idx) {
                    return `${type}-${idx}`;
                },
                
                selectOption(key, index) {
                    this.$set(this.selectedOptions, key, index);
                },
                
                getSelectedOption(key) {
                    return this.selectedOptions[key] || 0;
                },
                
                toggleFullRaw(key) {
                    this.$set(this.showFullRaw, key, !this.showFullRaw[key]);
                },
                
                getOptionLabel(pool, option) {
                    if (!pool || !option) return '';
                    let index = -1;
                    // Try strict equality
                    index = pool.indexOf(option);
                    // Try JSON stringify comparison if strict equality fails (e.g. if objects are clones)
                    if (index === -1) {
                        try {
                            const optStr = JSON.stringify(option);
                            index = pool.findIndex(o => JSON.stringify(o) === optStr);
                        } catch (e) {}
                    }
                    return index !== -1 ? 'Choice ' + (index + 1) : '';
                },

                formatTime(isoString) {
                    if (!isoString) return 'N/A';
                    try {
                        const date = new Date(isoString);
                        return date.toLocaleString('th-TH', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } catch (e) {
                        return isoString;
                    }
                },
                
                formatUptime(seconds) {
                    if (!seconds) return '0s';
                    const days = Math.floor(seconds / 86400);
                    const hours = Math.floor((seconds % 86400) / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    const secs = seconds % 60;
                    const parts = [];
                        if (days > 0) parts.push(days + 'd');
                        if (hours > 0) parts.push(hours + 'h');
                        if (minutes > 0) parts.push(minutes + 'm');
                        if (secs > 0 || parts.length === 0) parts.push(secs + 's');
                    return parts.join(' ');
                },
                
                getFlightInfo(option) {
                    if (!option) return 'N/A';
                    
                    // Try to get Airline
                    let airlineCode = option.airline || option.carrier || 
                                     (option.flight?.segments?.[0]?.carrier) || 
                                     (option.segments?.[0]?.carrierCode);
                    let airlineName = this.getAirlineName(airlineCode);
                    
                    // Try to get Flight Number
                    let flightNum = option.flight_number || option.number || 
                                   (option.flight?.segments?.[0]?.flight_number) || 
                                   (option.segments?.[0]?.number) || '';
                                   
                    // Try to get Route
                    let origin = option.from || (option.flight?.segments?.[0]?.from) || 
                                (option.segments?.[0]?.departure?.iataCode) || '?';
                    let dest = option.to || (option.flight?.segments?.[0]?.to) || 
                              (option.segments?.[0]?.arrival?.iataCode) || '?';
                              
                    // Try to get Times
                    let depart = option.depart_time || option.departure_time || 
                                (option.flight?.segments?.[0]?.depart_time) || '';
                    let arrive = option.arrive_time || option.arrival_time || 
                                (option.flight?.segments?.[0]?.arrive_time) || '';
                                
                    // Try to get Price
                    let price = option.price || option.price_total || option.price_amount;
                    let currency = option.currency || 'THB';
                    let priceStr = price ? Number(price).toLocaleString() + ' ' + currency : '';

                    // Construct display string
                    let parts = [];
                    if (airlineName) parts.push(airlineName);
                    if (flightNum) parts.push(flightNum);
                    if (origin && dest && origin !== '?') parts.push('(' + origin + ' ‚ûù ' + dest + ')');
                    if (depart) parts.push('üïë ' + depart + ' - ' + arrive);
                    if (priceStr) parts.push('üí∞ ' + priceStr);
                    
                    return parts.length > 0 ? parts.join(' | ') : (option.title || 'N/A');
                },
                
                getAirlineName(code) {
                    if (!code) return '';
                    const airlineNames = {
                        'TG': 'Thai Airways', 'FD': 'Thai AirAsia', 'SL': 'Thai Lion Air', 'PG': 'Bangkok Airways',
                        'VZ': 'Thai Vietjet Air', 'WE': 'Thai Smile', 'XJ': 'Thai AirAsia X', 'DD': 'Nok Air',
                        'SQ': 'Singapore Airlines', 'MH': 'Malaysia Airlines', 'CX': 'Cathay Pacific',
                        'JL': 'Japan Airlines', 'NH': 'All Nippon Airways', 'KE': 'Korean Air',
                        'QR': 'Qatar Airways', 'EK': 'Qatar Airways', 'EY': 'Emirates'
                    };
                    return airlineNames[code.toUpperCase()] || code;
                },
                
                getAccommodationInfo(option) {
                    if (!option) return 'N/A';
                    return option.name || option.hotel_name || option.title || 'N/A';
                }
            }
        });
    </script>
</body>
</html>