# คู่มือทดสอบการแก้ไขย้อนหลัง (Retroactive Editing)

## วัตถุประสงค์
ทดสอบว่าระบบรองรับการแก้ไขย้อนหลังได้:
1. **จำนวนคน** (adults, children)
2. **วัน** (start_date, return_date, nights, days)
3. **จำนวน segment** (เพิ่ม/ลด hotel segments, flight segments)

---

## Test Scenarios

### Scenario 1: แก้ไขจำนวนคน (Edit Passengers)

**ขั้นตอน:**
1. สร้างทริป: `"ไปญี่ปุ่น 25 ธ.ค. 2 ผู้ใหญ่ 1 เด็ก"`
2. ระบบแสดง plan choices
3. เลือก plan
4. แก้ไข: `"เปลี่ยนเป็น 3 ผู้ใหญ่ 2 เด็ก"`

**ผลลัพธ์ที่คาดหวัง:**
- ✅ ระบบ re-search flights, hotels ด้วยจำนวนคนใหม่
- ✅ Response: `"✅ เปลี่ยนจำนวนผู้ใหญ่เป็น 3 คน. เปลี่ยนจำนวนเด็กเป็น 2 คน. ✅ พบตัวเลือก..."`
- ✅ ราคาใหม่สะท้อนจำนวนคนที่เปลี่ยน

---

### Scenario 2: แก้ไขวัน (Edit Dates)

**ขั้นตอน:**
1. สร้างทริป: `"ไปภูเก็ต 25 ธ.ค. 3 คืน 2 ผู้ใหญ่"`
2. เลือก plan
3. แก้ไข: `"เปลี่ยนเป็น 30 ธ.ค. 5 คืน"`

**ผลลัพธ์ที่คาดหวัง:**
- ✅ ระบบ re-search flights, hotels ด้วยวันที่ใหม่
- ✅ Response: `"✅ เปลี่ยนวันเดินทางเป็น 2024-12-30. เปลี่ยนจำนวนคืนเป็น 5 คืน. ✅ พบตัวเลือก..."`
- ✅ จำนวนคนยังคงอยู่ (2 ผู้ใหญ่)

---

### Scenario 3: เพิ่มที่พัก Segment (Add Hotel Segment)

**ขั้นตอน:**
1. สร้างทริปและเลือก plan ที่มีที่พัก 1 segment
2. แก้ไข: `"เพิ่มที่พัก 1 segment"` หรือ `"เพิ่มที่พัก 1"`

**ผลลัพธ์ที่คาดหวัง:**
- ✅ ระบบค้นหาที่พักใหม่
- ✅ Response: `"เลือกที่พักเพื่อเพิ่ม 1 segment:"`
- ✅ เมื่อเลือกที่พัก → เพิ่ม segment ใหม่เข้าไป
- ✅ Response: `"✅ เพิ่มที่พัก segment 2 สำเร็จ\nตอนนี้มีที่พัก 2 segment(s)"`

---

### Scenario 4: ลดที่พัก Segment (Remove Hotel Segment)

**ขั้นตอน:**
1. สร้างทริปและเลือก plan ที่มีที่พัก 3 segments
2. แก้ไข: `"ลดที่พัก 1 segment"` หรือ `"ลดที่พัก 1"`

**ผลลัพธ์ที่คาดหวัง:**
- ✅ ลบ segment สุดท้ายออก (segment 3)
- ✅ Response: `"✅ ลดที่พัก 1 segment สำเร็จ\nเหลือที่พัก 2 segment(s)"`
- ✅ ราคาใหม่คำนวณจาก segments ที่เหลือ

---

### Scenario 5: แก้ไขหลายอย่างพร้อมกัน

**ขั้นตอน:**
1. สร้างทริป: `"ไปญี่ปุ่น 25 ธ.ค. 3 คืน 2 ผู้ใหญ่"`
2. เลือก plan
3. แก้ไข: `"เปลี่ยนเป็น 30 ธ.ค. 5 คืน 3 ผู้ใหญ่"`

**ผลลัพธ์ที่คาดหวัง:**
- ✅ ระบบ re-search ด้วยข้อมูลใหม่ทั้งหมด
- ✅ Response แสดงการเปลี่ยนแปลงทั้งหมด
- ✅ ราคาใหม่สะท้อนการเปลี่ยนแปลงทั้งหมด

---

## Keywords ที่ระบบรองรับ

### การแก้ไขจำนวนคน:
- `"เปลี่ยนเป็น 3 ผู้ใหญ่"`
- `"เพิ่มเด็ก 1"`
- `"ลดผู้ใหญ่ 1"`
- `"เปลี่ยนจำนวนคนเป็น 4 คน"`

### การแก้ไขวัน:
- `"เปลี่ยนเป็น 30 ธ.ค."`
- `"ขยับวัน +1"`
- `"เปลี่ยนเป็น 5 คืน"`
- `"เพิ่มวัน 2 วัน"`

### การเพิ่ม/ลด Segment:
- `"เพิ่มที่พัก 1 segment"`
- `"เพิ่มที่พัก 1"`
- `"ลดที่พัก 1 segment"`
- `"ลดที่พัก 1"`

---

## วิธีทดสอบ

### ผ่าน Frontend:
1. สร้างทริปและเลือก plan
2. พิมพ์คำสั่งแก้ไข (เช่น `"เปลี่ยนเป็น 3 ผู้ใหญ่"`)
3. ตรวจสอบว่า:
   - ระบบ re-search ด้วยข้อมูลใหม่
   - Response แสดงการเปลี่ยนแปลง
   - ราคาใหม่ถูกต้อง

### ผ่าน API:
```bash
# 1. สร้างทริป
curl -X POST http://localhost:8000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"user_id": "test", "message": "ไปญี่ปุ่น 25 ธ.ค. 3 คืน 2 ผู้ใหญ่"}'

# 2. เลือก plan (choice_id จาก response)
curl -X POST http://localhost:8000/api/select_choice \
  -H "Content-Type: application/json" \
  -d '{"user_id": "test", "choice_id": 1}'

# 3. แก้ไขจำนวนคน
curl -X POST http://localhost:8000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"user_id": "test", "message": "เปลี่ยนเป็น 3 ผู้ใหญ่"}'
```

---

## Checklist การทดสอบ

- [ ] แก้ไขจำนวนคน → ระบบ re-search และแสดงราคาใหม่
- [ ] แก้ไขวัน → ระบบ re-search และแสดงราคาใหม่
- [ ] แก้ไขจำนวนคืน → ระบบ re-search และแสดงราคาใหม่
- [ ] เพิ่มที่พัก segment → ระบบค้นหาและให้เลือก
- [ ] ลดที่พัก segment → ลบ segment สุดท้ายออก
- [ ] Response มี feedback ว่ามีการเปลี่ยนแปลงอะไร
- [ ] ข้อมูลที่ไม่ได้พูดถึงยังคงอยู่

---

## หมายเหตุ

- เมื่อแก้ไข **dates** หรือ **pax** → ระบบจะ **re-search** flights, hotels, cars ใหม่
- เมื่อแก้ไข **hotel** → ระบบจะค้นหา hotels ใหม่เท่านั้น
- เมื่อแก้ไข **flight** → ระบบจะค้นหา flights ใหม่เท่านั้น
- การเพิ่ม/ลด segment จะอัปเดตราคารวมอัตโนมัติ

