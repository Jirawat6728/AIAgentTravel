# คู่มือทดสอบการเปลี่ยนใจ (Non-linear Conversation)

## วัตถุประสงค์
ทดสอบว่าระบบรองรับการเปลี่ยนใจ (Correction/Modification) โดยไม่ต้องเริ่มใหม่ตั้งแต่ศูนย์

## Test Scenarios

### Scenario 1: การเปลี่ยนปลายทาง (Destination Change)

**ขั้นตอน:**
1. ส่งข้อความ: `"จองตั๋วไป เชียงใหม่ พรุ่งนี้"`
2. ระบบควรถาม: `"เดินทางจากที่ไหนครับ?"` (ถ้ายังไม่มี origin)
3. ส่งข้อความ: `"เอ้ย ไม่เอาเชียงใหม่แล้ว ไป ภูเก็ต ดีกว่า"`
4. ระบบควรตอบ: `"✅ เปลี่ยนปลายทาง จาก เชียงใหม่ เป็น ภูเก็ต. เดินทางจากที่ไหนครับ?"`
5. **ตรวจสอบ:** วันที่ (พรุ่งนี้) ควรยังอยู่ ไม่หายไป

**ผลลัพธ์ที่คาดหวัง:**
- ✅ Destination เปลี่ยนเป็น Phuket
- ✅ Date ยังคงอยู่ (ไม่หายไป)
- ✅ Response มี feedback ว่าเปลี่ยนอะไร

---

### Scenario 2: การเปลี่ยนหลายครั้ง (Multiple Corrections)

**ขั้นตอน:**
1. ส่งข้อความ: `"ไปญี่ปุ่น 25 ธ.ค. 2 ผู้ใหญ่"`
2. ส่งข้อความ: `"เปลี่ยนใจไปเกาหลีแทน"`
3. ส่งข้อความ: `"เอา เปลี่ยนเป็น 3 ผู้ใหญ่"`

**ผลลัพธ์ที่คาดหวัง:**
- ✅ Destination: เกาหลี (ไม่ใช่ญี่ปุ่น)
- ✅ Date: 25 ธ.ค. (ยังคงอยู่)
- ✅ Adults: 3 (ไม่ใช่ 2)

---

### Scenario 3: การเปลี่ยนวันที่ (Date Change)

**ขั้นตอน:**
1. ส่งข้อความ: `"ไปภูเก็ต 25 ธ.ค. 2 ผู้ใหญ่"`
2. ส่งข้อความ: `"เปลี่ยนเป็น 30 ธ.ค. แทน"`

**ผลลัพธ์ที่คาดหวัง:**
- ✅ Destination: ภูเก็ต (ยังคงอยู่)
- ✅ Date: 30 ธ.ค. (เปลี่ยนแล้ว)
- ✅ Adults: 2 (ยังคงอยู่)

---

### Scenario 4: การเปลี่ยนจำนวนผู้โดยสาร (Passengers Change)

**ขั้นตอน:**
1. ส่งข้อความ: `"ไปญี่ปุ่น 25 ธ.ค. 2 ผู้ใหญ่ 1 เด็ก"`
2. ส่งข้อความ: `"เปลี่ยนเป็น 3 ผู้ใหญ่ 2 เด็ก"`

**ผลลัพธ์ที่คาดหวัง:**
- ✅ Destination: ญี่ปุ่น (ยังคงอยู่)
- ✅ Date: 25 ธ.ค. (ยังคงอยู่)
- ✅ Adults: 3 (เปลี่ยนแล้ว)
- ✅ Children: 2 (เปลี่ยนแล้ว)

---

## วิธีทดสอบผ่าน API

### ใช้ curl หรือ Postman

```bash
# Turn 1: Initial request
curl -X POST http://localhost:8000/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "test_user",
    "message": "จองตั๋วไป เชียงใหม่ พรุ่งนี้",
    "client_trip_id": "test_trip_1"
  }'

# Turn 2: Change mind
curl -X POST http://localhost:8000/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "test_user",
    "message": "เอ้ย ไม่เอาเชียงใหม่แล้ว ไป ภูเก็ต ดีกว่า",
    "client_trip_id": "test_trip_1"
  }'
```

### ตรวจสอบผลลัพธ์

ดูใน response:
- `travel_slots.destination` - ควรเป็น "Phuket" หรือ "ภูเก็ต"
- `travel_slots.start_date` - ควรยังคงอยู่ (ไม่เป็น null)
- `response` - ควรมีคำว่า "เปลี่ยน" หรือ "change"

---

## วิธีทดสอบผ่าน Frontend

1. เปิดแอปใน browser
2. ส่งข้อความแรก: `"จองตั๋วไป เชียงใหม่ พรุ่งนี้"`
3. รอให้ระบบตอบกลับ
4. ส่งข้อความที่สอง: `"เอ้ย ไม่เอาเชียงใหม่แล้ว ไป ภูเก็ต ดีกว่า"`
5. ตรวจสอบว่า:
   - Bot ตอบกลับว่ามีการเปลี่ยนข้อมูล
   - วันที่ยังคงอยู่ (ไม่หายไป)
   - ระบบถามต่อเรื่องที่ยังขาด (เช่น origin)

---

## Checklist การทดสอบ

- [ ] เปลี่ยน destination → วันที่ยังอยู่
- [ ] เปลี่ยน date → destination ยังอยู่
- [ ] เปลี่ยน adults → destination และ date ยังอยู่
- [ ] Response มี feedback ว่าเปลี่ยนอะไร
- [ ] ข้อมูลที่ไม่ได้พูดถึงยังคงอยู่
- [ ] Workflow ไม่พัง (ไม่ต้องเริ่มใหม่)

---

## Keywords ที่ระบบรองรับ

ระบบจะตรวจจับการเปลี่ยนใจจาก keywords เหล่านี้:
- `"เปลี่ยนใจ"`
- `"เปลี่ยน"`
- `"แก้ไข"`
- `"ไม่เอา"`
- `"เอา"`
- `"แทน"`
- `"change"`
- `"modify"`
- `"edit"`
- `"instead"`
- `"rather"`

---

## หมายเหตุ

- ระบบใช้ **State-based Logic** แทน Hardcode ลำดับคำถาม
- ข้อมูลที่ไม่ได้พูดถึงจะ**คงเดิม** (ไม่หายไป)
- ระบบจะ**เขียนทับ**เฉพาะข้อมูลที่ผู้ใช้ระบุใหม่
- Response จะมี** feedback** เพื่อให้ผู้ใช้มั่นใจว่าระบบรับทราบการเปลี่ยนแปลง

